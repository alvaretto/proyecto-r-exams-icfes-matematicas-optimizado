```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(exams)
library(knitr)

# Función para generar datos válidos con mayor eficiencia y claridad
generate_valid_data <- function(max_attempts = 1000) {
  for (attempt in 1:max_attempts) {
    # Generar valores base con rangos más amplios y realistas
    n_total <- sample(40:60, 1)  # Aumentamos el rango de total
    n_A <- sample(20:35, 1)      # Aumentamos el rango de A, B y C
    n_B <- sample(20:35, 1)
    n_C <- sample(25:40, 1)

    # Generar intersecciones, asegurando consistencia
    n_AB <- sample(5:12, 1)   # Aumentamos las intersecciones
    n_AC <- sample(7:15, 1)
    n_BC <- sample(5:12, 1)
    n_all <- sample(3:7, 1)    # Intersección de los tres

    # Ajustar intersecciones si son mayores que conjuntos individuales
    n_AB <- min(n_AB, n_A, n_B)
    n_AC <- min(n_AC, n_A, n_C)
    n_BC <- min(n_BC, n_B, n_C)
    n_all <- min(n_all, n_AB, n_AC, n_BC)

    # Calcular valores para cada región
    n_only_A <- n_A - n_AB - n_AC + n_all
    n_only_B <- n_B - n_AB - n_BC + n_all
    n_only_C <- n_C - n_AC - n_BC + n_all
    n_AB_only <- n_AB - n_all
    n_AC_only <- n_AC - n_all
    n_BC_only <- n_BC - n_all

    # Calcular el número de personas que no escuchan ninguno
    n_none <- n_total - (n_only_A + n_only_B + n_only_C + n_AB_only + n_AC_only + n_BC_only + n_all)

    # Verificar que todos los valores sean no negativos
    if (all(c(n_only_A, n_only_B, n_only_C, n_AB_only, n_AC_only, n_BC_only, n_all, n_none) >= 0) && n_none <= 15) { #Añadida una restricción para que n_none no sea tan grande
      # Devolver los valores generados
      return(list(
        n_total = n_total, n_A = n_A, n_B = n_B, n_C = n_C,
        n_AB = n_AB, n_AC = n_AC, n_BC = n_BC, n_all = n_all,
        n_only_A = n_only_A, n_only_B = n_only_B, n_only_C = n_only_C,
        n_AB_only = n_AB_only, n_AC_only = n_AC_only, n_BC_only = n_BC_only,
        n_none = n_none
      ))
    }
  }
  stop("No se pudieron generar datos válidos después de ", max_attempts, " intentos")
}

# Función para generar géneros musicales aleatorios
generate_random_genres <- function() {
  genres <- c("Vallenato", "Salsa", "Merengue", "Reggaeton", "Bachata", "Cumbia",
              "Rap", "Electrónica", "Rock", "Pop") #Añadidos más géneros
  sample(genres, 3)
}

# Función para generar texto aleatorio con números consistentes - Mejorada
generate_random_text <- function(data, A, B, C) {
  # Plantillas más variadas y con mejor redacción
  templates <- c(
    "- %d personas escuchan %s y %s.\n- %d escuchan %s y %s.\n- %d disfrutan de %s y %s.",
    "- %d escuchan exclusivamente %s y %s.\n- %d también escuchan %s y %s.\n- %d personas disfrutan de %s y %s.",
    "- %d personas disfrutan de %s y %s.\n- %d escuchan solo %s y %s.\n- %d personas disfrutan de %s y %s.",
    "- %d personas escuchan %s y %s.\n- %d también escuchan %s y %s.\n- %d escuchan solo %s y %s."
  )

  template <- sample(templates, 1)
    
  #Valores de las plantillas
    values <- list(
    c(data$n_AB, data$n_AC, data$n_BC),
    c(data$n_AB_only, data$n_AC, data$n_BC),
    c(data$n_AB, data$n_AC_only, data$n_BC),
    c(data$n_AB, data$n_AC, data$n_BC_only)
  )
  chosen_values <- switch(which(templates == template),
                        values[[1]],
                        values[[2]],
                        values[[3]],
                        values[[4]])
  
    #Mejoras en la redacción
  sprintf(
    "En una encuesta realizada a %d jóvenes sobre sus preferencias musicales, se encontró que:\n\n- %d de ellos escuchan %s.\n- %d prefieren %s.\n- %d disfrutan de %s.\n\nAdemás, se sabe que:\n\n%s",
    data$n_total, data$n_A, A, data$n_B, B, data$n_C, C,
    sprintf(template, chosen_values[1], A, B, chosen_values[2], A, C, chosen_values[3], B, C)
  )
}

# Generar datos válidos
tryCatch({
  data <- generate_valid_data()
}, error = function(e) {
  stop("Error al generar datos válidos: ", e$message)
})

# Asignar valores a variables individuales
list2env(data, envir = environment())

# Crear géneros musicales aleatorios
genres <- generate_random_genres()
A <- genres[1]
B <- genres[2]
C <- genres[3]

# Generar texto aleatorio con números consistentes
random_text <- generate_random_text(data, A, B, C)

# Lista de preguntas - Mejorada
questions <- c(
  sprintf("¿Cuántas personas escuchan exclusivamente %s y %s?", A, B),
  sprintf("¿Cuántas personas disfrutan únicamente de %s y %s?", A, C),
  sprintf("¿Cuántos de los encuestados solo escuchan %s y %s?", B, C),
  "¿Cuántas personas escuchan los tres géneros musicales?",
  "¿Cuántos de los jóvenes encuestados no escuchan ninguno de estos géneros musicales?",
  "¿Cuántas personas escuchan exactamente uno de estos géneros musicales?",
  "¿Cuántos entrevistados disfrutan de al menos dos géneros musicales?",
  "¿Cuántas personas escuchan exactamente dos géneros musicales?",
  sprintf("¿Cuántas personas escuchan %s o %s, pero no ambos?", A, B),
  sprintf("¿Cuántas personas disfrutan de %s pero no de %s?", A, B),
  sprintf("¿Cuántas personas disfrutan de %s o %s, o ambos?", A, C),
  sprintf("¿Cuántos encuestados no escuchan ni %s ni %s?", B, C),
  "¿Cuántos jóvenes encuestados escuchan al menos uno de estos géneros musicales?",
  "¿Cuántas personas escuchan únicamente un género musical?"
)

# Respuestas correspondientes a las preguntas
answers <- c(
  n_AB_only,
  n_AC_only,
  n_BC_only,
  n_all,
  n_none,
  n_only_A + n_only_B + n_only_C,
  n_AB + n_AC + n_BC - 2 * n_all,
  n_AB_only + n_AC_only + n_BC_only,
  n_only_A + n_only_B,
  n_only_A + n_AC_only,
  n_A + n_C - n_AC,
  n_total - (n_B + n_C - n_BC),
  n_total - n_none,
  n_only_A + n_only_B + n_only_C
)

# Seleccionar 4 preguntas aleatorias
selected_questions <- sample(questions, 4)

# Seleccionar las respuestas correspondientes
selected_answers <- answers[match(selected_questions, questions)]

# Usar el mismo tipo de gráfico (pdf, svg, png) que la llamada actual de xweave()
typ <- match_exams_device()

# Código TikZ para el Diagrama de Venn - Simplificado

tikz_venn <- sprintf('
\\begin{tikzpicture}[scale=0.7]
  \\begin{scope}[opacity=0.5]
    \\fill[red]   ( 90:1.5) circle (2);
    \\fill[green] (210:1.5) circle (2);
    \\fill[blue]  (330:1.5) circle (2);
  \\end{scope}
  \\node at ( 90:3.3) {%s};
  \\node at (210:3.3) {%s};
  \\node at (330:3.3) {%s};
  \\node at ( 90:1.3) {%d};
  \\node at (210:1.3) {%d};
  \\node at (330:1.3) {%d};
  \\node at ( 30:1.7) {%d};
  \\node at (150:1.7) {%d};
  \\node at (270:1.7) {%d};
  \\node at (0:0) {%d};
  \\node at (270:3.5) {Ninguno: %d};
\\end{tikzpicture}
', A, B, C, n_only_A, n_only_B, n_only_C, n_AC_only, n_AB_only, n_BC_only, n_all, n_none
)

# Configuración de knitr para TikZ
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# Función para incluir el diagrama TikZ
include_venn <- function() {
  include_tikz(
    tikz_venn,
    name = "venn_diagram",
    markup = "markdown",
    format = typ,
    library = c("shapes", "backgrounds"),
    packages = c("tikz"),
    width = "6cm"
  )
}
```

Question
========

`r random_text`

Por último, sabemos que `r n_all` personas disfrutan de los tres géneros musicales.

Considerando esa información, responda las siguientes preguntas:

Answerlist
----------

* `r selected_questions[1]`
* `r selected_questions[2]`
* `r selected_questions[3]`
* `r selected_questions[4]`

Solution
========

Para resolver este problema, analizamos el diagrama de Venn que representa la intersección de los tres conjuntos: `r A`, `r B` y `r C`.

```{r venn-diagram-solution, echo=FALSE, results="asis", fig.align="center", fig.width=6, fig.height=6}
include_venn()
```

Explicación detallada:

a) `r selected_questions[1]`: `r selected_answers[1]`
   
b) `r selected_questions[2]`: `r selected_answers[2]`
   
c) `r selected_questions[3]`: `r selected_answers[3]`
   
d) `r selected_questions[4]`: `r selected_answers[4]`

Answerlist
----------

* La respuesta correcta es `r selected_answers[1]`.
* La respuesta correcta es `r selected_answers[2]`.
* La respuesta correcta es `r selected_answers[3]`.
* La respuesta correcta es `r selected_answers[4]`.

Meta-information
================
exname: Géneros musicales
extype: cloze
exclozetype: num|num|num|num
exsolution: `r selected_answers[1]`|`r selected_answers[2]`|`r selected_answers[3]`|`r selected_answers[4]`
extol: 0
exsection: Diagrama de Venn
